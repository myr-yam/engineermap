<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Engineer Map Picker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ArcGIS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.27/"></script>

    <style>
      html, body, #viewDiv {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .custom-toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 6px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 99;
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 120px;
      }
      .custom-toolbar button {
        padding: 4px;
        font-size: 12px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>

    <!-- Toolbar -->
    <div class="custom-toolbar">
      <button id="saveLocationBtn">Save Location</button>
      <button id="clearBtn">Clear</button>
    </div>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/GraphicsLayer",
        "esri/Graphic"
      ], function(Map, MapView, GraphicsLayer, Graphic) {

        // Get form ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get("form_id") || "";

        // Default coordinates (Dubai as fallback)
        let selectedLat = parseFloat(urlParams.get("lat")) || 25.276987;
        let selectedLng = parseFloat(urlParams.get("lng")) || 55.296249;

        const graphicsLayer = new GraphicsLayer();

        const map = new Map({
          basemap: "streets-navigation-vector",
          layers: [graphicsLayer]
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [selectedLng, selectedLat],
          zoom: 16
        });

        // If coordinates already exist, place marker
        if (urlParams.get("lat") && urlParams.get("lng")) {
          addMarker(selectedLat, selectedLng);
        }

        // Click to select location
        view.on("click", function(event) {
          const lat = event.mapPoint.latitude;
          const lng = event.mapPoint.longitude;
          selectedLat = lat;
          selectedLng = lng;
          addMarker(lat, lng);
        });

        function addMarker(lat, lng) {
          graphicsLayer.removeAll();
          graphicsLayer.add(new Graphic({
            geometry: { type: "point", longitude: lng, latitude: lat },
            symbol: { type: "simple-marker", color: "blue", size: "12px" }
          }));
        }

        // Save button
        document.getElementById("saveLocationBtn").addEventListener("click", () => {
          if (!selectedLat || !selectedLng) {
            alert("Please select a location on the map first.");
            return;
          }

          window.parent.postMessage({
            type: "engineerLocation",
            form_id: formId,
            coordinates_lat: selectedLat,
            coordinates_lng: selectedLng
          }, "*");

          alert("Location saved to Joget.");
        });

        // Clear button
        document.getElementById("clearBtn").addEventListener("click", () => {
          graphicsLayer.removeAll();
          selectedLat = null;
          selectedLng = null;
        });
      });
    </script>
  </body>
</html>
