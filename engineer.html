<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Engineer Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.27/"></script>
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    .toolbar {
      position: absolute; top: 10px; right: 10px; background: white;
      padding: 6px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 99; display: flex; flex-direction: column; gap: 4px; width: 120px;
    }
    .toolbar button { padding: 4px; font-size: 12px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div class="toolbar">
    <button id="saveBtn">Save Location</button>
    <button id="clearBtn">Clear</button>
  </div>
<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer", "esri/Graphic"
], function(Map, MapView, GraphicsLayer, Graphic) {

  const params = new URLSearchParams(window.location.search);
  const formId = params.get("form_id") || "";
  let selectedLat = parseFloat(params.get("lat")) || 25.276987;
  //let selectedLng = parseFloat(params.get("lng")) ;
  //alert("found"+selectedLng);
  let selectedLng = parseFloat(params.get("lng")) || 55.296249;
  const sketchesData = params.get("sketches") ? JSON.parse(decodeURIComponent(params.get("sketches"))) : [];

  const graphicsLayer = new GraphicsLayer();
  const sketchLayer = new GraphicsLayer();

  const map = new Map({ basemap: "streets-navigation-vector", layers: [graphicsLayer, sketchLayer] });
  const view = new MapView({ container: "viewDiv", map, center: [selectedLng, selectedLat], zoom: 16 });

  // Add engineer marker if exists
  if (params.get("lat") && params.get("lng")) addMarker(selectedLat, selectedLng);

  // Add supervisor sketches if any
  sketchesData.forEach(g => {
    sketchLayer.add(new Graphic({
      geometry: g.geometry,
      symbol: g.symbol
    }));
  });

  view.on("click", evt => {
    selectedLat = evt.mapPoint.latitude;
    selectedLng = evt.mapPoint.longitude;
    addMarker(selectedLat, selectedLng);
     if (!selectedLat || !selectedLng) return alert("Select a location first.");
    window.parent.postMessage({
      type: "saveEngineerLocation",
      form_id: formId,
      coordinates_lat: selectedLat,
      coordinates_lng: selectedLng
    }, "*");
  });

  function addMarker(lat, lng) {
    graphicsLayer.removeAll();
    graphicsLayer.add(new Graphic({
      geometry: { type: "point", longitude: lng, latitude: lat },
      symbol: { type: "simple-marker", color: "blue", size: "12px" }
    }));
  }

//  document.getElementById("saveBtn").onclick = () => {
  //  if (!selectedLat || !selectedLng) return alert("Select a location first.");
   // window.parent.postMessage({
    //  type: "saveEngineerLocation",
     // form_id: formId,
      //coordinates_lat: selectedLat,
      //coordinates_lng: selectedLng
    //}, "*");
    // alert("Location saved.");
  };

  document.getElementById("clearBtn").onclick = () => {
    graphicsLayer.removeAll();
    selectedLat = null; selectedLng = null;
  };
});
</script>
</body>
</html>
