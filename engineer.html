<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Engineer Inspection Map</title>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    #coordinatesPanel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 99;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .save-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 6px;
    }
    .save-button:hover { background: #218838; }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="coordinatesPanel">
    <div><strong>Selected Location:</strong></div>
    <div id="coordsDisplay">Click on the map to select</div>
    <button class="save-button" onclick="saveCoordinates()">ðŸ’¾ Save Location</button>
  </div>

<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/GraphicsLayer", "esri/Graphic", "esri/geometry/Point"
], function(Map, MapView, GraphicsLayer, Graphic, Point) {

  const formId = new URLSearchParams(window.location.search).get("form_id");
  const map = new Map({ basemap: "topo-vector" });
  const graphicsLayer = new GraphicsLayer();
  map.add(graphicsLayer);

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [31.2357, 30.0444], // Cairo default
    zoom: 10
  });

  const pointSymbol = {
    type: "simple-marker",
    color: [255, 0, 0],
    size: 12,
    outline: { color: [255, 255, 255], width: 2 }
  };

  let selectedCoordinates = null;

  view.on("click", function(event) {
    const lat = event.mapPoint.latitude;
    const lon = event.mapPoint.longitude;
    selectedCoordinates = { latitude: lat, longitude: lon };

    graphicsLayer.removeAll();
    graphicsLayer.add(new Graphic({
      geometry: new Point({ longitude: lon, latitude: lat }),
      symbol: pointSymbol
    }));

    document.getElementById("coordsDisplay").innerHTML = 
      `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
  });

  window.saveCoordinates = function() {
    if (!selectedCoordinates) {
      alert("Please select a location first.");
      return;
    }
    // Send data to Joget hidden fields
    if (window.parent) {
      window.parent.postMessage({
        type: "inspectionCoordinates",
        form_id: formId,
        lat: selectedCoordinates.latitude,
        lng: selectedCoordinates.longitude
      }, "*");
    }
    alert("Coordinates saved to form.");
  };
});
</script>
</body>
</html>
